<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#B31921">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="CIM Training">

  <title>CIM Marathon Training</title>

  <link rel="manifest" href="./manifest.json">
  <link rel="stylesheet" href="./css/styles.css">

  <!-- Icons -->
  <link rel="icon" type="image/png" sizes="192x192" href="./icons/icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="./icons/icon-512.png">
  <link rel="apple-touch-icon" href="./icons/icon-192.png">
</head>
<body>
  <div id="app">
    <main id="main-content">
      <!-- Content will be dynamically rendered here -->
      <div style="padding: 40px 20px; text-align: center; color: #757575;">
        <p>Loading...</p>
        <p style="font-size:10px;color:#bbb;margin-top:20px;">v1.3</p>
      </div>
    </main>

    <nav class="bottom-nav">
      <button class="nav-item active" data-view="today">
        <span class="nav-icon">ğŸ“…</span>
        <span>Today</span>
      </button>
      <button class="nav-item" data-view="week">
        <span class="nav-icon">ğŸ“Š</span>
        <span>Week</span>
      </button>
      <button class="nav-item" data-view="library">
        <span class="nav-icon">ğŸ’ª</span>
        <span>Library</span>
      </button>
      <button class="nav-item" data-view="running">
        <span class="nav-icon">ğŸƒ</span>
        <span>Running</span>
      </button>
      <button class="nav-item" data-view="settings">
        <span class="nav-icon">âš™ï¸</span>
        <span>Settings</span>
      </button>
    </nav>
  </div>

  <!-- Inline safety net and diagnostics -->
  <script>
  (function() {
    // Collect errors from script loading/parsing
    window._loadErrors = [];
    window.onerror = function(msg, url, line, col, err) {
      window._loadErrors.push(msg + ' at ' + url + ':' + line + ':' + col);
    };

    window.clearAndReload = function() {
      var cleanup = Promise.resolve();
      if ('serviceWorker' in navigator) {
        cleanup = navigator.serviceWorker.getRegistrations().then(function(regs) {
          return Promise.all(regs.map(function(r) { return r.unregister(); }));
        }).then(function() {
          return caches.keys();
        }).then(function(names) {
          return Promise.all(names.map(function(n) { return caches.delete(n); }));
        });
      }
      // Force-refresh JS/CSS files in HTTP cache, then reload
      cleanup.then(function() {
        var files = ['./js/data.js','./js/idb-storage.js','./js/storage.js','./js/app.js','./css/styles.css','./index.html'];
        return Promise.all(files.map(function(f) {
          return fetch(f, {cache:'reload'}).catch(function() {});
        }));
      }).then(function() {
        window.location.reload();
      });
    };

    // Safety timer: if app hasn't loaded after 6s, show diagnostics
    window._appSafetyTimer = setTimeout(function() {
      var el = document.getElementById('main-content');
      if (!el) return;
      var p = el.querySelector('p');
      if (!p || p.textContent !== 'Loading...') return;

      // Check which globals loaded
      var missing = [];
      if (typeof PROGRAM === 'undefined') missing.push('data.js');
      if (typeof IDBStorage === 'undefined') missing.push('idb-storage.js');
      if (typeof Storage === 'undefined' || typeof Storage.initStorage === 'undefined') missing.push('storage.js');
      if (typeof App === 'undefined') missing.push('app.js');

      var info = '';
      if (missing.length > 0) {
        info = '<p>Failed scripts: ' + missing.join(', ') + '</p>';
      } else {
        info = '<p>All scripts loaded but app did not initialize.</p>';
      }
      if (window._loadErrors.length > 0) {
        info += '<p style="font-size:12px;word-break:break-all;">Errors: ' + window._loadErrors.join(' | ') + '</p>';
      }

      el.innerHTML = '<div style="padding:20px;text-align:center;">' +
        '<p style="color:#D32F2F;font-size:16px;margin-bottom:12px;">App failed to load.</p>' +
        '<div style="color:#333;font-size:13px;margin-bottom:16px;text-align:left;padding:0 10px;">' + info + '</div>' +
        '<button onclick="clearAndReload()" style="padding:12px 24px;background:#4285F4;color:#fff;border:none;border-radius:8px;font-size:16px;cursor:pointer;">Clear Cache & Reload</button>' +
        '</div>';
    }, 6000);
  })();
  </script>

  <!-- Scripts -->
  <script src="./js/data.js"></script>
  <script src="./js/idb-storage.js"></script>
  <script src="./js/storage.js"></script>
  <script src="./js/app.js"></script>
</body>
</html>
